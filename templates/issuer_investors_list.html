{% extends "base.html" %}

{% block title %}Investors - {{ token.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="token-selector">
                <h6 class="mb-2">
                    <i class="fas fa-coins me-2"></i>Select Token
                </h6>
                <select class="form-select" id="tokenSelector" onchange="changeToken()">
                    <option value="">Choose a token...</option>
                    {% for t in tokens %}
                        <option value="{{ t.id }}" {% if t.id == token.id %}selected{% endif %}>
                            {{ t.name }} ({{ t.symbol }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <nav class="nav flex-column">
                <!-- Dashboard -->
                <a class="nav-link" href="{{ url_for('issuer.dashboard', tab_session=tab_session_id) }}">
                    <i class="fas fa-tachometer-alt"></i>Dashboard
                </a>
                
                <!-- Token Management -->
                <div class="mt-3">
                    <h6 class="px-3 text-muted text-uppercase small">Token Management</h6>
                    <div class="submenu">
                        <a class="nav-link" href="{{ url_for('issuer.token_actions', token_id=token.id, tab_session=tab_session_id) }}">
                            <i class="fas fa-cogs"></i>Actions
                        </a>
                        <a class="nav-link" href="{{ url_for('issuer.token_agents', token_id=token.id, tab_session=tab_session_id) }}">
                                                            <i class="fas fa-users-cog"></i>Agents & TI
                        </a>
                        <a class="nav-link" href="{{ url_for('issuer.token_transactions', token_id=token.id, tab_session=tab_session_id) }}">
                            <i class="fas fa-exchange-alt"></i>Transactions
                        </a>
                        <a class="nav-link" href="{{ url_for('issuer.token_requests', token_id=token.id, tab_session=tab_session_id) }}">
                            <i class="fas fa-clipboard-list"></i>Requests
                        </a>
                    </div>
                </div>
                
                <!-- Investors -->
                <div class="mt-3">
                    <h6 class="px-3 text-muted text-uppercase small">Investors</h6>
                    <div class="submenu">
                        <a class="nav-link active" href="{{ url_for('issuer.investors_list', token_id=token.id, tab_session=tab_session_id) }}">
                            <i class="fas fa-users"></i>All Investors
                        </a>
                    </div>
                </div>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 main-content">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-users me-2"></i>
                        Investors - {{ token.name }}
                    </h1>
                    <p class="text-muted mb-0">
                        Manage investors for {{ token.symbol }} token
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('issuer.dashboard', token_id=token.id, tab_session=tab_session_id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
            
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ investors|length }}</h4>
                                    <small>Total Investors</small>
                                </div>
                                <div>
                                    <i class="fas fa-users fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ investors|selectattr('kyc_status', 'equalto', 'approved')|list|length }}</h4>
                                    <small>KYC Approved</small>
                                </div>
                                <div>
                                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ investors|selectattr('kyc_status', 'equalto', 'pending')|list|length }}</h4>
                                    <small>KYC Pending</small>
                                </div>
                                <div>
                                    <i class="fas fa-clock fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ investors|selectattr('kyc_status', 'equalto', 'rejected')|list|length }}</h4>
                                    <small>KYC Rejected</small>
                                </div>
                                <div>
                                    <i class="fas fa-times-circle fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Investors Table -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            All Investors
                        </h5>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search investors..." onkeyup="filterTable()">
                            <select class="form-select form-select-sm" id="statusFilter" onchange="filterTable()">
                                <option value="">All Status</option>
                                <option value="approved">Approved</option>
                                <option value="pending">Pending</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if investors %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="investorsTable">
                                <thead>
                                    <tr>
                                        <th>Wallet Address</th>
                                        <th>Email</th>
                                        <th>KYC Status</th>
                                        <th>Registration Date</th>
                                        <th>Token Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for investor in investors %}
                                    <tr data-status="{{ investor.kyc_status }}">
                                        <td>
                                            <code>{{ investor.wallet_address }}</code>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" data-address="{{ investor.wallet_address }}" onclick="copyToClipboard(this.dataset.address)">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </td>
                                        <td>{{ investor.email or 'Not provided' }}</td>
                                        <td>
                                            {% if investor.kyc_status == 'approved' %}
                                                <span class="badge bg-success">Approved</span>
                                            {% elif investor.kyc_status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif investor.kyc_status == 'rejected' %}
                                                <span class="badge bg-danger">Rejected</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Unknown</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ investor.created_at.strftime('%b %d, %Y') }}</td>
                                        <td>
                                            <span class="text-muted" id="bal-{{ investor.id }}">Loading... {{ token.symbol }}</span>
                                            <small class="text-muted d-block" id="verif-{{ investor.id }}"></small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" data-investor-id="{{ investor.id }}" onclick="viewDetails(this.dataset.investorId)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" data-investor-id="{{ investor.id }}" onclick="mintTokensPrompt(this.dataset.investorId)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5>No Investors Found</h5>
                            <p class="text-muted">No investors have registered for this token yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Investor Details Modal -->
<div class="modal fade" id="investorDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Investor Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="investorDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const tabSession = '{{ tab_session_id }}';

async function fetchInvestorRow(investorId) {
    const res = await fetch(`/issuer/api/token/{{ token.id }}/investor/${investorId}?tab_session=${tabSession}`);
    const data = await res.json();
    if (!data.success) return;
    document.getElementById(`bal-${investorId}`).textContent = `${Number(data.balance).toLocaleString()} {{ token.symbol }}`;
    document.getElementById(`verif-${investorId}`).innerHTML = data.verified
        ? '<span class="badge bg-success">Verified</span>'
        : '<span class="badge bg-warning">Not Verified</span>';
}

document.addEventListener('DOMContentLoaded', function() {
    const investorIds = JSON.parse('{{ investors|map(attribute="id")|list|tojson|safe }}');
    investorIds.forEach(id => fetchInvestorRow(id));
});
function changeToken() {
    const tokenId = document.getElementById('tokenSelector').value;
    if (tokenId) {
        // Get current page path to determine where to redirect
        const currentPath = window.location.pathname;
        const currentSearch = window.location.search;
        
        // Extract current token_id from URL if it exists
        const urlParams = new URLSearchParams(currentSearch);
        const currentTokenId = urlParams.get('token_id');
        
        // If we're on a token-specific page, redirect to the same page with new token
        if (currentPath.includes('/token/') && currentTokenId) {
            // Replace the current token_id with the new one
            const newSearch = currentSearch.replace(`token_id=${currentTokenId}`, `token_id=${tokenId}`);
            window.location.href = currentPath + newSearch;
        } else {
            // Default to dashboard
            window.location.href = `{{ url_for('issuer.dashboard') }}?token_id=${tokenId}&tab_session={{ tab_session_id }}`;
        }
    } else {
        // If no token selected, go to dashboard without token
        const currentPath = window.location.pathname;
        if (currentPath.includes('/token/')) {
            // If on token page, go to dashboard
            window.location.href = `{{ url_for('issuer.dashboard') }}?tab_session={{ tab_session_id }}`;
        } else {
            // Already on dashboard, just clear token
            window.location.href = `{{ url_for('issuer.dashboard') }}?tab_session={{ tab_session_id }}`;
        }
    }
}

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const table = document.getElementById('investorsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        const address = row.cells[0].textContent.toLowerCase();
        const email = row.cells[1].textContent.toLowerCase();
        const status = row.getAttribute('data-status');
        
        const matchesSearch = address.includes(searchTerm) || email.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        
        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show a temporary tooltip or alert
        alert('Address copied to clipboard!');
    });
}

async function viewDetails(investorId) {
    const res = await fetch(`/issuer/api/token/{{ token.id }}/investor/${investorId}?tab_session=${tabSession}`);
    const data = await res.json();
    if (!data.success) {
        document.getElementById('investorDetailsContent').innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to load investor'}</div>`;
        new bootstrap.Modal(document.getElementById('investorDetailsModal')).show();
        return;
    }
    const inv = data.investor;
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <p><strong>Wallet Address:</strong> <code>${inv.wallet_address}</code></p>
                <p><strong>Email:</strong> ${inv.email || 'Not provided'}</p>
                <p><strong>Registration Date:</strong> ${inv.created_at ? new Date(inv.created_at).toLocaleDateString() : 'Unknown'}</p>
                <p><strong>OnchainID:</strong> ${inv.onchain_id ? `<code>${inv.onchain_id}</code>` : '<span class="badge bg-warning">Not Registered</span>'}</p>
                <p><strong>KYC Status:</strong> <span class="badge bg-${inv.kyc_status === 'approved' ? 'success' : (inv.kyc_status === 'pending' ? 'warning' : (inv.kyc_status === 'rejected' ? 'danger' : 'secondary'))}">${inv.kyc_status || 'unknown'}</span></p>
            </div>
            <div class="col-md-6">
                <h6>Token Information</h6>
                <p><strong>Token Balance:</strong> ${Number(data.balance).toLocaleString()} {{ token.symbol }}</p>
                <p><strong>IR Status:</strong> ${data.ir_added ? '<span class="badge bg-success">Added</span>' : '<span class="badge bg-warning">Not Added</span>'}</p>
                <p><strong>Verification:</strong> ${data.verified ? '<span class="badge bg-success">Verified</span>' : `<span class=\"badge bg-warning\">Not Verified${data.verification_reason ? ' - ' + data.verification_reason : ''}</span>`}</p>
            </div>
        </div>
    `;
    document.getElementById('investorDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('investorDetailsModal')).show();
}

async function mintTokensPrompt(investorId) {
    const amountStr = prompt('Enter amount of {{ token.symbol }} to mint:');
    if (!amountStr) return;
    const amount = Number(amountStr);
    if (isNaN(amount) || amount <= 0) { alert('Invalid amount'); return; }
    // Fetch investor to get address
    const resInv = await fetch(`/issuer/api/token/{{ token.id }}/investor/${investorId}?tab_session=${tabSession}`);
    const dataInv = await resInv.json();
    if (!dataInv.success) { alert(dataInv.error || 'Failed to load investor'); return; }
    const toAddress = dataInv.investor.wallet_address;
    const res = await fetch(`/issuer/api/token/{{ token.id }}/mint?tab_session=${tabSession}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to_address: toAddress, amount })
    });
    const data = await res.json();
    if (data.success) {
        alert('Mint successful. Tx: ' + data.tx_hash);
        fetchInvestorRow(investorId);
    } else {
        alert('Mint failed: ' + (data.error || 'Unknown error'));
    }
}
</script>
{% endblock %}